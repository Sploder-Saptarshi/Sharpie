name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            runner_bin: Sharpie.Runner.RaylibCs
            sdk_bin: Sharpie.Sdk
          - os: windows-latest
            rid: win-x64
            runner_bin: Sharpie.Runner.RaylibCs.exe
            sdk_bin: Sharpie.Sdk.exe
          - os: windows-11-arm
            rid: win-arm64
            runner_bin: Sharpie.Runner.RaylibCs.exe
            sdk_bin: Sharpie.Sdk.exe

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Cache raylib DLL for Windows ARM64
        if: matrix.rid == 'win-arm64'
        id: cache-raylib
        uses: actions/cache@v4
        with:
          path: src/Sharpie.Runner/RaylibCs/libs/win-arm64/native/raylib.dll
          key: raylib-5.5-win-arm64

      - name: Build raylib from source for Windows on ARM
        if: matrix.rid == 'win-arm64' && steps.cache-raylib.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          git clone --depth 1 --branch 5.5 https://github.com/raysan5/raylib.git
          cd raylib
          
          mkdir build
          cd build
          
          cmake .. -A ARM64 -DBUILD_SHARED_LIBS=ON -DBUILD_EXAMPLES=OFF
          
          cmake --build . --config Release
          
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/src/Sharpie.Runner/RaylibCs/libs/win-arm64/native"
          
          Copy-Item "raylib/Release/raylib.dll" "${{ github.workspace }}/src/Sharpie.Runner/RaylibCs/libs/win-arm64/native/raylib.dll"
          
          Get-ChildItem "${{ github.workspace }}/src/Sharpie.Runner/RaylibCs/libs/win-arm64/native/"

      - name: Publish Runner & SDK
        run: |
          dotnet publish ./src/Sharpie.Runner/RaylibCs/Sharpie.Runner.RaylibCs.csproj -c Release -r ${{ matrix.rid }} -o ./pub-runner -p:SelfContained=true -p:UseAppHost=true

          dotnet publish ./tools/Sharpie.Sdk/Sharpie.Sdk.csproj -c Release -r ${{ matrix.rid }} -o ./pub-sdk -p:SelfContained=true -p:UseAppHost=true

      - name: Assemble Packages
        shell: bash
        run: |
          EXT=""
          if [[ "${{ matrix.rid }}" == win* ]]; then EXT=".exe"; fi

          mv ./pub-runner/${{ matrix.runner_bin }} ./pub-runner/Sharpie$EXT
          cp assets/RELEASE_README.md ./pub-runner/README.md
          cp LICENSE.md ./pub-runner/LICENSE.txt

          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            cp assets/icons/icon.png ./pub-runner/
            cp assets/linux/sharpie-raylib.desktop ./pub-runner/
          fi

          mv ./pub-sdk/${{ matrix.sdk_bin }} ./pub-sdk/Sharpie-ASM$EXT
          cp LICENSE.md ./pub-sdk/LICENSE.txt     # Add License to SDK
          echo "Sharpie SDK v0.1 - Drag a .asm file onto Sharpie-ASM$EXT to create a .shr cartridge." > ./pub-sdk/README.txt

          if [[ "${{ matrix.rid }}" == win* ]]; then
            7z a "sharpie-runner-${{ matrix.rid }}.zip" ./pub-runner/*
            7z a "sharpie-sdk-${{ matrix.rid }}.zip" ./pub-sdk/*
          else
            (cd pub-runner && zip -r ../sharpie-runner-${{ matrix.rid }}.zip .)
            (cd pub-sdk && zip -r ../sharpie-sdk-${{ matrix.rid }}.zip .)
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sharpie-packages-${{ matrix.rid }}
          path: |
            sharpie-runner-${{ matrix.rid }}.zip
            sharpie-sdk-${{ matrix.rid }}.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push'
        with:
          files: |
            sharpie-runner-${{ matrix.rid }}.zip
            sharpie-sdk-${{ matrix.rid }}.zip
          body_path: assets/RELEASE_README.md
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  build-web:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install WASM tools
        run: dotnet workload install wasm-tools

      - name: Publish Web Runner
        run: |
          dotnet publish ./src/Sharpie.Runner/Web/Sharpie.Runner.Web.csproj -c Release

      - name: Assemble Web Package
        run: |
          cd src/Sharpie.Runner/Web/bin/Release/net10.0/browser-wasm/AppBundle
          zip -r ${{ github.workspace }}/sharpie-runner-web.zip .
          cd ${{ github.workspace }}
          
          # Create a README for web version
          echo "Sharpie Console - Web Edition" > web-README.txt
          echo "" >> web-README.txt
          echo "To run:" >> web-README.txt
          echo "1. Extract all files to a directory" >> web-README.txt
          echo "2. Serve the directory with a web server" >> web-README.txt
          echo "3. Open index.html in your browser" >> web-README.txt
          echo "" >> web-README.txt
          echo "Example using Python:" >> web-README.txt
          echo "  python -m http.server 8080" >> web-README.txt
          echo "  Then open: http://localhost:8080" >> web-README.txt

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sharpie-packages-web
          path: sharpie-runner-web.zip

      - name: Create GitHub Release (Web)
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push'
        with:
          files: sharpie-runner-web.zip
          body_path: assets/RELEASE_README.md
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
